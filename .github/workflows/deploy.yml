name: Deploy ircstore

on:
 push:
   branches: [main]
 workflow_dispatch:

jobs:
 deploy:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v3
     
     - name: Build Docker image
       run: |
         docker build -t ircstore:latest .
         docker save ircstore:latest | gzip > ircstore.tar.gz
     
     - name: Deploy to server
       uses: appleboy/scp-action@v0.1.5
       with:
         host: ${{ secrets.DEPLOY_HOST }}
         username: ${{ secrets.DEPLOY_USER }}
         key: ${{ secrets.DEPLOY_KEY }}
         source: "ircstore.tar.gz,docker-compose.yml"
         target: "/home/ircstore/"
     
     - name: Start services
       uses: appleboy/ssh-action@v1.0.0
       with:
         host: ${{ secrets.DEPLOY_HOST }}
         username: ${{ secrets.DEPLOY_USER }}
         key: ${{ secrets.DEPLOY_KEY }}
         script: |
           cd /home/ircstore
           docker load < ircstore.tar.gz
           docker-compose down
           docker-compose up -d
           rm ircstore.tar.gz
